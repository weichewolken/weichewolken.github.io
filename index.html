<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Firebase Schedule Cards</title>
  <style>
    /* --- ここはあなたのCSSそのまま --- */
    /* 長いので省略できますが、元のCSSをそのまま貼り付けてOK */
  </style>
</head>
<body>
  <!-- あなたのHTML構造（header, sidebar, main, modal等）そのまま -->
  <!-- ★ 元のHTML構造をそのまま貼ってください ★ -->

  <script type="module">
    // ======== Firebase 初期化 =========
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore, doc, setDoc, updateDoc, deleteDoc,
      getDoc, onSnapshot, collection
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // あなたの Firebase 設定に差し替えてください
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ======== ここから元の変数群 ========
    const cardContainer = document.getElementById('card-container');
    const inputForm = document.getElementById('input-form');
    const cardText = document.getElementById('card-text');
    const colorPalette = document.getElementById('color-palette');
    const colorToggle = document.getElementById('color-toggle');
    const editModal = document.getElementById('edit-modal');
    const editText = document.getElementById('edit-text');
    const modalColorPalette = document.getElementById('modal-color-palette');

    const menuButton = document.getElementById('menu-button');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const currentDateDisplay = document.getElementById('current-date');
    const addDateInput = document.getElementById('add-date-input');
    const addDateBtn = document.getElementById('add-date-btn');
    const dateList = document.getElementById('date-list');

    const colors = ['#ff8a80','#ffcc80','#fff59d','#c8e6c9','#80deea','#b39ddb','#f48fb1','#a1887f','#90a4ae','#e0e0e0'];
    let selectedColor = colors[0];
    let editingIndex = -1;
    let editingColor = colors[0];
    let colorPaletteVisible = false;

    let allData = {};
    let currentDate = getTodayString();

    function getTodayString() {
      return new Date().toISOString().split('T')[0];
    }

    function formatDateForDisplay(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      const weekdays = ['日','月','火','水','木','金','土'];
      return `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日（${weekdays[date.getDay()]}）`;
    }

    // Firestore リアルタイム監視
    onSnapshot(collection(db, "schedules"), (snapshot) => {
      allData = {};
      snapshot.forEach(docSnap => {
        allData[docSnap.id] = docSnap.data().cards || [];
      });
      if (!allData[currentDate]) {
        allData[currentDate] = [];
      }
      renderCards();
      renderDateList();
    });

    // Firestore保存
    async function saveCurrentDateCards() {
      await setDoc(doc(db, "schedules", currentDate), {
        cards: allData[currentDate]
      });
    }

    // 日付追加
    addDateBtn.addEventListener('click', async () => {
      const dateStr = addDateInput.value;
      if (dateStr && !allData[dateStr]) {
        allData[dateStr] = [];
        await setDoc(doc(db, "schedules", dateStr), { cards: [] });
        addDateInput.value = '';
      }
    });

    // 日付削除
    async function deleteDate(dateStr) {
      if (dateStr === getTodayString()) {
        alert('今日の予定は削除できません');
        return;
      }
      if (confirm(`${formatDateForDisplay(dateStr)}の予定を削除しますか？`)) {
        await deleteDoc(doc(db, "schedules", dateStr));
        if (currentDate === dateStr) {
          currentDate = getTodayString();
        }
      }
    }

    // UIレンダリング
    function renderDateList() {
      dateList.innerHTML = '';
      Object.keys(allData).sort().forEach(dateStr => {
        const dateItem = document.createElement('div');
        dateItem.className = 'date-item' + (dateStr === currentDate ? ' active' : '');
        dateItem.innerHTML = `
          <span>${formatDateForDisplay(dateStr)}</span>
          <button class="delete-date-btn">削除</button>
        `;
        dateItem.querySelector('.delete-date-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          deleteDate(dateStr);
        });
        dateItem.addEventListener('click', () => switchDate(dateStr));
        dateList.appendChild(dateItem);
      });
    }

    function switchDate(dateStr) {
      currentDate = dateStr;
      currentDateDisplay.textContent = formatDateForDisplay(dateStr);
      renderCards();
      renderDateList();
      closeSidebar();
    }

    function renderCards() {
      cardContainer.innerHTML = '';
      (allData[currentDate] || []).forEach((c, i) => createCardElement(c, i));
    }

    function createCardElement(c, index) {
      const card = document.createElement('div');
      card.className = 'card';
      card.textContent = c.text;
      card.style.backgroundColor = c.color + 'AA';
      card.style.left = c.x + 'px';
      card.style.top = c.y + 'px';
      card.style.width = c.width + 'px';
      card.style.height = c.height + 'px';

      card.addEventListener('dblclick', () => {
        editingIndex = index;
        editingColor = c.color;
        editText.value = c.text;
        document.querySelectorAll('.modal-color-option').forEach((el, i) => {
          el.classList.toggle('selected', colors[i] === c.color);
        });
        editModal.style.display = 'block';
      });

      makeDraggableAndResizable(card, c);
      cardContainer.appendChild(card);
    }

    function makeDraggableAndResizable(card, cObj) {
      let isDragging = false;
      let offsetX, offsetY;
      card.addEventListener('mousedown', (e) => {
        isDragging = true;
        const rect = card.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
      });
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const rect = cardContainer.getBoundingClientRect();
        cObj.x = e.clientX - rect.left - offsetX;
        cObj.y = e.clientY - rect.top - offsetY;
        card.style.left = cObj.x + 'px';
        card.style.top = cObj.y + 'px';
      });
      document.addEventListener('mouseup', async () => {
        if (isDragging) {
          isDragging = false;
          await saveCurrentDateCards();
        }
      });
    }

    // カード追加
    inputForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const c = {
        text: cardText.value,
        color: selectedColor,
        x: 20,
        y: 20,
        width: 200,
        height: 120
      };
      allData[currentDate].push(c);
      await saveCurrentDateCards();
      cardText.value = '';
    });

    // モーダル保存
    window.saveEdit = async function() {
      if (editingIndex >= 0) {
        allData[currentDate][editingIndex].text = editText.value;
        allData[currentDate][editingIndex].color = editingColor;
        await saveCurrentDateCards();
        closeModal();
      }
    };

    window.deleteCard = async function() {
      if (editingIndex >= 0) {
        allData[currentDate].splice(editingIndex, 1);
        await saveCurrentDateCards();
        closeModal();
      }
    };

    window.closeModal = function() {
      editModal.style.display = 'none';
      editingIndex = -1;
    };

    // 初期表示
    currentDateDisplay.textContent = formatDateForDisplay(currentDate);
  </script>
</body>
</html>
